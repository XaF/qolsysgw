name: Build

on:
  push:
    branches:
      - main
      - xaf/test_end_to_end_setup
  pull_request:
  schedule:
    - cron: "0 0 * * *"

jobs:
  end-to-end-tests:
    name: End-to-end tests
    runs-on: "ubuntu-latest"
    steps:
      - name: Checkout current commit
        uses: "actions/checkout@v3"

      - name: Print docker versions
        run: |
          docker version
          docker compose version

      - name: Prepare environment
        run: |
          # Get the python version from the AppDaemon's Dockerfile
          # which was used to build the latest AppDaemon's docker
          # container
          PYTHON_VERSION=$(\
            curl -s https://raw.githubusercontent.com/AppDaemon/appdaemon/dev/Dockerfile | \
            grep -oP "(?<=python:)[0-9\.]*")
          echo "PYTHON_VERSION=${PYTHON_VERSION}" | tee -a "$GITHUB_ENV"

          PYTHON_MAJOR=${PYTHON_VERSION%%.*}
          echo "PYTHON_MAJOR=${PYTHON_MAJOR}" | tee -a "$GITHUB_ENV"

      - name: Install python
        uses: "actions/setup-python@v4"
        with:
          python-version: '${{ env.PYTHON_VERSION }}'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-clarity pytest-subtests
          pip install -r tests/end-to-end/requirements.txt

      - name: Run end-to-end tests
        id: tests
        run: |
          set -eo pipefail
          pytest --cache-clear tests/end-to-end/

